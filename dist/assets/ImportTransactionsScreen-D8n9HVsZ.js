import{j as e,p as ee,m as te,K as ae,N as se,E as re,a as oe,z as T}from"./ui-CqB_xnuP.js";import{u as ne,q as ie,c as M,d as N,w as ce,g as B,e as U,f as H}from"./index-BUU1lA4v.js";import{d as le,r as x}from"./vendor-UbVtIYU6.js";import{B as K}from"./Button-Bj4TVVN4.js";import{P as L}from"./papaparse.min-DAjTYYde.js";import{u as de}from"./useCategories-CE2nb58C.js";import{u as me}from"./useTransactions-CxoIO0TM.js";import"./utils-Bk4gEjOa.js";const pe=l=>{if(!l)return null;let r=new Date(l);if(!isNaN(r.getTime()))return r;const D=l.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(D){const[,d,m,g]=D;if(r=new Date(`${g}-${d.padStart(2,"0")}-${m.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const u=l.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(u){const[,d,m,g]=u;if(r=new Date(`${g}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const f=l.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(f){const[,d,m,g]=f;if(r=new Date(`${g}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const j=l.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(j){const[,d,m,g]=j;if(r=new Date(`${g}-${d.padStart(2,"0")}-${m.padStart(2,"0")}`),!isNaN(r.getTime()))return r}return null},ve=()=>{const l=le(),{user:r}=ne();de();const{refetch:D}=me(),[u,f]=x.useState(null),[j,d]=x.useState([]),[m,g]=x.useState([]),[k,F]=x.useState([]),[w,$]=x.useState({}),[z,E]=x.useState(!1),Q=t=>{if(t.target.files&&t.target.files[0]){const a=t.target.files[0];f(a),L.parse(a,{header:!0,skipEmptyLines:!0,preview:5,complete:o=>{d(o.data);const i=o.meta.fields||[];F(i);const p={};i.forEach(h=>{const y=h.toLowerCase();y.includes("date")?p[h]="date":y.includes("desc")?p[h]="description":y.includes("amount")?p[h]="amount":y.includes("type")?p[h]="type":y.includes("cat")?p[h]="category":p[h]="ignore"}),$(p)}}),L.parse(a,{header:!0,skipEmptyLines:!0,complete:o=>{g(o.data)}})}},G=(t,a)=>{$(o=>({...o,[t]:a}))},_=x.useMemo(()=>{const t=Object.values(w);return["date","description","amount","type","category"].every(a=>t.includes(a))},[w]),J=()=>{const t=[{date:"2025-07-30",description:"Groceries",category:"Food",type:"expense",amount:2500},{date:"2025-07-29",description:"Monthly Salary",category:"Salary",type:"income",amount:5e4}],a=L.unparse(t),o=new Blob([a],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),p=URL.createObjectURL(o);i.setAttribute("href",p),i.setAttribute("download","cointrail_sample.csv"),document.body.appendChild(i),i.click(),document.body.removeChild(i)},W=async()=>{if(!u||!r||m.length===0)return;E(!0);const t=T.loading("Starting import...");try{const a=m,o=Object.entries(w).reduce((s,[n,c])=>(c!=="ignore"&&(s[c]=n),s),{}),i=ie(M(N,"categories"),ce("user_id","==",r.uid)),y=(await B(i)).docs.map(s=>({id:s.id,...s.data()}))||[];let q=0,I=0,P=0;const A=new Set(y.map(s=>s.name.toLowerCase())),v=[];for(const s of a){const n=s[o.category]?.trim();n&&!A.has(n.toLowerCase())&&(A.add(n.toLowerCase()),v.push(n))}if(v.length>0){const s=U(N);v.forEach(n=>{const c=H(M(N,"categories"));s.set(c,{name:n,type:"expense",user_id:r.uid,created_at:new Date().toISOString()})}),await s.commit(),P=v.length}const Y=(await B(i)).docs.map(s=>({id:s.id,...s.data()})),C=[];for(const s of a){const n=s[o.description]?.trim(),c=parseFloat(s[o.amount]),O=s[o.date]?.trim(),b=s[o.type]?.trim().toLowerCase(),S=s[o.category]?.trim(),R=pe(O);if(n&&!isNaN(c)&&c>0&&R&&(b==="income"||b==="expense")&&S){const V=Y.find(Z=>Z.name.toLowerCase()===S.toLowerCase());V?(C.push({description:n,amount:c,transaction_date:R.toISOString().split("T")[0],type:b,category_id:V.id,user_id:r.uid}),q++):I++}else I++}if(C.length>0)for(let n=0;n<C.length;n+=500){const c=U(N);C.slice(n,n+500).forEach(b=>{const S=H(M(N,"transactions"));c.set(S,{...b,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})}),await c.commit()}T.success(`Import complete! ${q} transactions added, ${P} categories created, ${I} skipped.`,{id:t,duration:5e3}),l("/dashboard")}catch(a){console.error("Import error:",a),T.error("Import failed. Please check your CSV format and try again.",{id:t,duration:5e3})}finally{E(!1)}},X=[{value:"date",label:"Date"},{value:"description",label:"Description"},{value:"amount",label:"Amount"},{value:"type",label:"Type (income/expense)"},{value:"category",label:"Category Name"},{value:"ignore",label:"Ignore this column"}];return e.jsxs("div",{className:"min-h-screen bg-dark-primary text-white p-4 sm:p-6 lg:p-8 pb-20",children:[e.jsxs("header",{className:"flex items-center justify-between mb-8",children:[e.jsx("button",{onClick:()=>l(-1),className:"p-2 rounded-full bg-dark-secondary",children:e.jsx(ee,{size:24,className:"text-gray-400"})}),e.jsx("h1",{className:"text-xl font-bold",children:"Import Transactions"}),e.jsx("div",{className:"w-10"})]}),e.jsxs(te.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-8",children:[e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"1. Upload CSV File"}),e.jsxs("div",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-700 rounded-xl p-8 text-center mb-4",children:[e.jsx(ae,{size:40,className:"text-gray-500 mb-3"}),e.jsx("h3",{className:"font-semibold",children:"Drag & drop or click to upload"}),e.jsx("input",{type:"file",id:"file-upload",className:"hidden",accept:".csv",onChange:Q}),e.jsx("label",{htmlFor:"file-upload",className:"mt-2 text-brand-green font-semibold cursor-pointer hover:underline",children:"Choose a file"})]}),u&&e.jsxs("div",{className:"bg-dark-primary p-3 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{size:20,className:"text-gray-400"}),e.jsx("span",{children:u.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:[(u.size/1024).toFixed(2)," KB"]}),e.jsx("button",{onClick:()=>{f(null),d([]),F([]),$({})},className:"text-red-400 hover:text-red-300 text-sm font-medium",children:"Remove"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(K,{onClick:J,className:"bg-gray-700 hover:bg-gray-600 w-auto text-sm py-2",children:"Download Sample CSV"})})]}),u&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"2. Map Columns"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Match the columns from your CSV to the required fields."}),e.jsx("div",{className:"space-y-3",children:k.map(t=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsx("span",{className:"font-semibold truncate",title:t,children:t}),e.jsx("select",{value:w[t],onChange:a=>G(t,a.target.value),className:"w-full p-2 bg-dark-primary border border-gray-700 rounded-lg text-sm",children:X.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]},t))})]}),u&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"3. Preview & Import"}),!_&&e.jsxs("div",{className:"flex items-center gap-3 bg-yellow-900/50 text-yellow-300 p-3 rounded-lg mb-4 text-sm",children:[e.jsx(re,{size:20}),e.jsx("p",{children:"Please map all required fields: Date, Description, Amount, Type, Category."})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-700",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-dark-primary",children:e.jsx("tr",{children:k.map(t=>e.jsx("th",{className:"p-3",children:t},t))})}),e.jsx("tbody",{children:j.map((t,a)=>e.jsx("tr",{className:"border-t border-gray-700",children:k.map(o=>e.jsx("td",{className:"p-3 truncate",children:t[o]},o))},a))})]})}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx("button",{onClick:()=>l(-1),className:"flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-4 rounded-xl text-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50",children:"Cancel"}),e.jsx(K,{onClick:W,disabled:!_||z,className:"flex-1",children:z?e.jsx(oe,{className:"animate-spin"}):"Import Transactions"})]})]})]})]})};export{ve as default};
