import{j as e,p as H,m as R,y as K,B as G,u as J,a as Q,z as x}from"./ui-Dy4X14_K.js";import{f as W,r as b}from"./vendor-gOpYt1fm.js";import{B as P}from"./Button-BdbUWFle.js";import{P as S}from"./papaparse.min-smZJhByJ.js";import{u as X}from"./useCategories-Cytt2SIa.js";import{u as Y}from"./useTransactions-9cdBbzWI.js";import{u as Z,s as D}from"./index-CbbJHnKT.js";import"./utils-Bk4gEjOa.js";import"./supabase-RyWy78zx.js";const ee=y=>{if(!y)return null;let r=new Date(y);if(!isNaN(r.getTime()))return r;const j=y.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(j){const[,h,f,m]=j;if(r=new Date(`${m}-${h.padStart(2,"0")}-${f.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const v=y.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(v){const[,h,f,m]=v;if(r=new Date(`${m}-${f.padStart(2,"0")}-${h.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const u=y.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(u){const[,h,f,m]=u;if(r=new Date(`${m}-${f.padStart(2,"0")}-${h.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const C=y.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(C){const[,h,f,m]=C;if(r=new Date(`${m}-${h.padStart(2,"0")}-${f.padStart(2,"0")}`),!isNaN(r.getTime()))return r}return null},de=()=>{const y=W(),{user:r}=Z(),{refetch:j}=X(),{refetch:v}=Y(),[u,C]=b.useState(null),[h,f]=b.useState([]),[m,A]=b.useState([]),[$,k]=b.useState({}),[M,I]=b.useState(!1),_=t=>{if(t.target.files&&t.target.files[0]){const s=t.target.files[0];C(s),S.parse(s,{header:!0,skipEmptyLines:!0,preview:5,complete:l=>{f(l.data);const g=l.meta.fields||[];A(g);const c={};g.forEach(d=>{const n=d.toLowerCase();n.includes("date")?c[d]="date":n.includes("desc")?c[d]="description":n.includes("amount")?c[d]="amount":n.includes("type")?c[d]="type":n.includes("cat")?c[d]="category":c[d]="ignore"}),k(c)}})}},q=(t,s)=>{k(l=>({...l,[t]:s}))},T=b.useMemo(()=>{const t=Object.values($);return["date","description","amount","type","category"].every(s=>t.includes(s))},[$]),B=()=>{const t=[{date:"2025-07-30",description:"Groceries",category:"Food",type:"expense",amount:2500},{date:"2025-07-29",description:"Monthly Salary",category:"Salary",type:"income",amount:5e4}],s=S.unparse(t),l=new Blob([s],{type:"text/csv;charset=utf-8;"}),g=document.createElement("a"),c=URL.createObjectURL(l);g.setAttribute("href",c),g.setAttribute("download","cointrail_sample.csv"),document.body.appendChild(g),g.click(),document.body.removeChild(g)},V=async()=>{if(!u||!r)return;I(!0);const t=x.loading("Starting import...");try{const{data:s,error:l}=await D.from("categories").select("id, name, type").eq("user_id",r.id);if(l)throw new Error(`Failed to fetch categories: ${l.message}`);const g=new Set(s.map(a=>`${a.name.toLowerCase()}|${a.type}`));let c=new Map(s.map(a=>[`${a.name.toLowerCase()}|${a.type}`,a.id]));const d=await new Promise(a=>{S.parse(u,{header:!0,skipEmptyLines:!0,complete:p=>a(p.data)})});x.loading(`Processing ${d.length} rows...`,{id:t});const n=Object.entries($).reduce((a,[p,o])=>(o!=="ignore"&&(a[o]=p),a),{}),N=new Map;for(const a of d){const p=a[n.category]?.trim(),o=a[n.type]?.toLowerCase().trim();if(p&&o&&(o==="income"||o==="expense")){const i=`${p.toLowerCase()}|${o}`;!g.has(i)&&!N.has(i)&&N.set(i,{name:p,type:o})}}if(N.size>0){x.loading(`Creating ${N.size} new categories...`,{id:t});const a=Array.from(N.values()).map(i=>({...i,user_id:r.id})),{data:p,error:o}=await D.from("categories").insert(a).select();if(o)throw new Error(`Failed to create categories: ${o.message}`);p.forEach(i=>c.set(`${i.name.toLowerCase()}|${i.type}`,i.id))}x.loading(`Preparing ${d.length} transactions for import...`,{id:t});const w=[];let L=0;for(const a of d){const p=a[n.category]?.trim(),o=a[n.type]?.toLowerCase().trim(),i=parseFloat(a[n.amount]),E=a[n.description]?.trim(),U=a[n.date]?.trim(),F=ee(U),z=c.get(`${p.toLowerCase()}|${o}`);E&&!isNaN(i)&&i>0&&F&&z?w.push({user_id:r.id,description:E,amount:i,type:o,category_id:z,transaction_date:F.toISOString(),notes:a.notes||null}):L++}if(w.length>0){x.loading(`Importing ${w.length} transactions...`,{id:t});const{error:a}=await D.from("transactions").insert(w);if(a)throw new Error(`Failed to insert transactions: ${a.message}`)}await v(),await j(),x.success(`Import complete! ${w.length} transactions added, ${L} skipped.`,{id:t,duration:5e3}),y("/dashboard")}catch(s){x.error(s.message,{id:t,duration:5e3})}finally{I(!1)}},O=[{value:"date",label:"Date"},{value:"description",label:"Description"},{value:"amount",label:"Amount"},{value:"type",label:"Type (income/expense)"},{value:"category",label:"Category Name"},{value:"ignore",label:"Ignore this column"}];return e.jsxs("div",{className:"min-h-screen bg-dark-primary text-white p-4 sm:p-6",children:[e.jsxs("header",{className:"flex items-center justify-between mb-8",children:[e.jsx("button",{onClick:()=>y(-1),className:"p-2 rounded-full bg-dark-secondary",children:e.jsx(H,{size:24,className:"text-gray-400"})}),e.jsx("h1",{className:"text-xl font-bold",children:"Import Transactions"}),e.jsx("div",{className:"w-10"})]}),e.jsxs(R.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-8",children:[e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"1. Upload CSV File"}),e.jsxs("div",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-700 rounded-xl p-8 text-center mb-4",children:[e.jsx(K,{size:40,className:"text-gray-500 mb-3"}),e.jsx("h3",{className:"font-semibold",children:"Drag & drop or click to upload"}),e.jsx("input",{type:"file",id:"file-upload",className:"hidden",accept:".csv",onChange:_}),e.jsx("label",{htmlFor:"file-upload",className:"mt-2 text-brand-green font-semibold cursor-pointer hover:underline",children:"Choose a file"})]}),u&&e.jsxs("div",{className:"bg-dark-primary p-3 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(G,{size:20,className:"text-gray-400"}),e.jsx("span",{children:u.name})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[(u.size/1024).toFixed(2)," KB"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(P,{onClick:B,className:"bg-gray-700 hover:bg-gray-600 w-auto text-sm py-2",children:"Download Sample CSV"})})]}),u&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"2. Map Columns"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Match the columns from your CSV to the required fields."}),e.jsx("div",{className:"space-y-3",children:m.map(t=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsx("span",{className:"font-semibold truncate",title:t,children:t}),e.jsx("select",{value:$[t],onChange:s=>q(t,s.target.value),className:"w-full p-2 bg-dark-primary border border-gray-700 rounded-lg text-sm",children:O.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]},t))})]}),u&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"3. Preview & Import"}),!T&&e.jsxs("div",{className:"flex items-center gap-3 bg-yellow-900/50 text-yellow-300 p-3 rounded-lg mb-4 text-sm",children:[e.jsx(J,{size:20}),e.jsx("p",{children:"Please map all required fields: Date, Description, Amount, Type, Category."})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-700",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-dark-primary",children:e.jsx("tr",{children:m.map(t=>e.jsx("th",{className:"p-3",children:t},t))})}),e.jsx("tbody",{children:h.map((t,s)=>e.jsx("tr",{className:"border-t border-gray-700",children:m.map(l=>e.jsx("td",{className:"p-3 truncate",children:t[l]},l))},s))})]})}),e.jsx("div",{className:"mt-6",children:e.jsx(P,{onClick:V,disabled:!T||M,className:"w-full",children:M?e.jsx(Q,{className:"animate-spin"}):"Import Transactions"})})]})]})]})};export{de as default};
