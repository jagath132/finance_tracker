import{j as e,p as W,m as X,K as Y,N as Z,E as ee,a as te,z as w}from"./ui-_IaUIWm1.js";import{u as ae,s as C}from"./index-Ita0Wmma.js";import{e as se,r as f}from"./vendor-CeoOk9QE.js";import{B as _}from"./Button-BYbGGxhE.js";import{P as I}from"./papaparse.min-Cew4rEdx.js";import{u as re}from"./useCategories-nji49Pe3.js";import{u as oe}from"./useTransactions-BwkPODxv.js";import"./utils-Bk4gEjOa.js";const ne=c=>{if(!c)return null;let s=new Date(c);if(!isNaN(s.getTime()))return s;const h=c.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(h){const[,g,l,d]=h;if(s=new Date(`${d}-${g.padStart(2,"0")}-${l.padStart(2,"0")}`),!isNaN(s.getTime()))return s}const N=c.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(N){const[,g,l,d]=N;if(s=new Date(`${d}-${l.padStart(2,"0")}-${g.padStart(2,"0")}`),!isNaN(s.getTime()))return s}const u=c.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(u){const[,g,l,d]=u;if(s=new Date(`${d}-${l.padStart(2,"0")}-${g.padStart(2,"0")}`),!isNaN(s.getTime()))return s}const b=c.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(b){const[,g,l,d]=b;if(s=new Date(`${d}-${g.padStart(2,"0")}-${l.padStart(2,"0")}`),!isNaN(s.getTime()))return s}return null},ye=()=>{const c=se(),{user:s}=ae(),{refetch:h}=re(),{refetch:N}=oe(),[u,b]=f.useState(null),[g,l]=f.useState([]),[d,q]=f.useState([]),[S,T]=f.useState([]),[j,k]=f.useState({}),[M,L]=f.useState(!1),B=t=>{if(t.target.files&&t.target.files[0]){const a=t.target.files[0];b(a),I.parse(a,{header:!0,skipEmptyLines:!0,preview:5,complete:r=>{l(r.data);const m=r.meta.fields||[];T(m);const n={};m.forEach(p=>{const y=p.toLowerCase();y.includes("date")?n[p]="date":y.includes("desc")?n[p]="description":y.includes("amount")?n[p]="amount":y.includes("type")?n[p]="type":y.includes("cat")?n[p]="category":n[p]="ignore"}),k(n)}}),I.parse(a,{header:!0,skipEmptyLines:!0,complete:r=>{q(r.data)}})}},O=(t,a)=>{k(r=>({...r,[t]:a}))},E=f.useMemo(()=>{const t=Object.values(j);return["date","description","amount","type","category"].every(a=>t.includes(a))},[j]),R=()=>{const t=[{date:"2025-07-30",description:"Groceries",category:"Food",type:"expense",amount:2500},{date:"2025-07-29",description:"Monthly Salary",category:"Salary",type:"income",amount:5e4}],a=I.unparse(t),r=new Blob([a],{type:"text/csv;charset=utf-8;"}),m=document.createElement("a"),n=URL.createObjectURL(r);m.setAttribute("href",n),m.setAttribute("download","cointrail_sample.csv"),document.body.appendChild(m),m.click(),document.body.removeChild(m)},U=async()=>{if(!u||!s||d.length===0)return;L(!0);const t=w.loading("Starting import...");try{const a=d,r=Object.entries(j).reduce((o,[i,x])=>(x!=="ignore"&&(o[x]=i),o),{});await h();const{data:m}=await C.from("categories").select("*").eq("user_id",s.id),n=m||[];let p=0,y=0,F=0;const P=new Set(n.map(o=>o.name.toLowerCase())),v=[];for(const o of a){const i=o[r.category]?.trim();i&&!P.has(i.toLowerCase())&&(P.add(i.toLowerCase()),v.push(i))}if(v.length>0){const o=v.map(x=>({name:x,type:"expense",user_id:s.id})),{error:i}=await C.from("categories").insert(o);i?console.error("Error creating categories:",i):F=v.length}const{data:K}=await C.from("categories").select("*").eq("user_id",s.id),G=K||n,D=[];for(const o of a){const i=o[r.description]?.trim(),x=parseFloat(o[r.amount]),J=o[r.date]?.trim(),$=o[r.type]?.trim().toLowerCase(),z=o[r.category]?.trim(),A=ne(J);if(i&&!isNaN(x)&&x>0&&A&&($==="income"||$==="expense")&&z){const V=G.find(Q=>Q.name.toLowerCase()===z.toLowerCase());V?(D.push({description:i,amount:x,transaction_date:A.toISOString().split("T")[0],type:$,category_id:V.id,user_id:s.id}),p++):y++}else y++}if(D.length>0){const{error:o}=await C.from("transactions").insert(D);if(o){console.error("Error importing transactions:",o),w.error("Import failed. Please check your CSV format and try again.",{id:t,duration:5e3});return}}await N(),await h(),w.success(`Import complete! ${p} transactions added, ${F} categories created, ${y} skipped.`,{id:t,duration:5e3}),c("/dashboard")}catch(a){console.error("Import error:",a),w.error("Import failed. Please check your CSV format and try again.",{id:t,duration:5e3})}finally{L(!1)}},H=[{value:"date",label:"Date"},{value:"description",label:"Description"},{value:"amount",label:"Amount"},{value:"type",label:"Type (income/expense)"},{value:"category",label:"Category Name"},{value:"ignore",label:"Ignore this column"}];return e.jsxs("div",{className:"min-h-screen bg-dark-primary text-white p-4 sm:p-6 lg:p-8 pb-20",children:[e.jsxs("header",{className:"flex items-center justify-between mb-8",children:[e.jsx("button",{onClick:()=>c(-1),className:"p-2 rounded-full bg-dark-secondary",children:e.jsx(W,{size:24,className:"text-gray-400"})}),e.jsx("h1",{className:"text-xl font-bold",children:"Import Transactions"}),e.jsx("div",{className:"w-10"})]}),e.jsxs(X.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-8",children:[e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"1. Upload CSV File"}),e.jsxs("div",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-700 rounded-xl p-8 text-center mb-4",children:[e.jsx(Y,{size:40,className:"text-gray-500 mb-3"}),e.jsx("h3",{className:"font-semibold",children:"Drag & drop or click to upload"}),e.jsx("input",{type:"file",id:"file-upload",className:"hidden",accept:".csv",onChange:B}),e.jsx("label",{htmlFor:"file-upload",className:"mt-2 text-brand-green font-semibold cursor-pointer hover:underline",children:"Choose a file"})]}),u&&e.jsxs("div",{className:"bg-dark-primary p-3 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{size:20,className:"text-gray-400"}),e.jsx("span",{children:u.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:[(u.size/1024).toFixed(2)," KB"]}),e.jsx("button",{onClick:()=>{b(null),l([]),T([]),k({})},className:"text-red-400 hover:text-red-300 text-sm font-medium",children:"Remove"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(_,{onClick:R,className:"bg-gray-700 hover:bg-gray-600 w-auto text-sm py-2",children:"Download Sample CSV"})})]}),u&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"2. Map Columns"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Match the columns from your CSV to the required fields."}),e.jsx("div",{className:"space-y-3",children:S.map(t=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsx("span",{className:"font-semibold truncate",title:t,children:t}),e.jsx("select",{value:j[t],onChange:a=>O(t,a.target.value),className:"w-full p-2 bg-dark-primary border border-gray-700 rounded-lg text-sm",children:H.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]},t))})]}),u&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"3. Preview & Import"}),!E&&e.jsxs("div",{className:"flex items-center gap-3 bg-yellow-900/50 text-yellow-300 p-3 rounded-lg mb-4 text-sm",children:[e.jsx(ee,{size:20}),e.jsx("p",{children:"Please map all required fields: Date, Description, Amount, Type, Category."})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-700",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-dark-primary",children:e.jsx("tr",{children:S.map(t=>e.jsx("th",{className:"p-3",children:t},t))})}),e.jsx("tbody",{children:g.map((t,a)=>e.jsx("tr",{className:"border-t border-gray-700",children:S.map(r=>e.jsx("td",{className:"p-3 truncate",children:t[r]},r))},a))})]})}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx("button",{onClick:()=>c(-1),className:"flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-4 rounded-xl text-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50",children:"Cancel"}),e.jsx(_,{onClick:U,disabled:!E||M,className:"flex-1",children:M?e.jsx(te,{className:"animate-spin"}):"Import Transactions"})]})]})]})]})};export{ye as default};
