import{j as e,p as W,m as X,y as Y,B as Z,u as ee,a as te,z as b}from"./ui-9V2nKd88.js";import{f as ae,r as N}from"./vendor-BLIq4JPC.js";import{B as V}from"./Button-fgWSp_I2.js";import{P as M}from"./papaparse.min-DsXab4K3.js";import{u as se}from"./useCategories-ITDpBBlg.js";import{u as re}from"./useTransactions-BKq-WBsM.js";import{u as oe,s as I}from"./index-B5lVPReX.js";import"./utils-CpJM9g8Q.js";import"./supabase-GK0Ohaqy.js";const ne=g=>{if(!g)return null;let s=new Date(g);if(!isNaN(s.getTime()))return s;const v=g.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(v){const[,y,h,c]=v;if(s=new Date(`${c}-${y.padStart(2,"0")}-${h.padStart(2,"0")}`),!isNaN(s.getTime()))return s}const C=g.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(C){const[,y,h,c]=C;if(s=new Date(`${c}-${h.padStart(2,"0")}-${y.padStart(2,"0")}`),!isNaN(s.getTime()))return s}const p=g.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(p){const[,y,h,c]=p;if(s=new Date(`${c}-${h.padStart(2,"0")}-${y.padStart(2,"0")}`),!isNaN(s.getTime()))return s}const $=g.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if($){const[,y,h,c]=$;if(s=new Date(`${c}-${y.padStart(2,"0")}-${h.padStart(2,"0")}`),!isNaN(s.getTime()))return s}return null},he=()=>{const g=ae(),{user:s}=oe(),{refetch:v}=se(),{refetch:C}=re(),[p,$]=N.useState(null),[y,h]=N.useState([]),[c,O]=N.useState([]),[S,T]=N.useState({}),[L,E]=N.useState(!1),U=t=>{if(t.target.files&&t.target.files[0]){const r=t.target.files[0];$(r),M.parse(r,{header:!0,skipEmptyLines:!0,preview:5,complete:i=>{h(i.data);const d=i.meta.fields||[];O(d);const l={};d.forEach(u=>{const f=u.toLowerCase();f.includes("date")?l[u]="date":f.includes("desc")?l[u]="description":f.includes("amount")?l[u]="amount":f.includes("type")?l[u]="type":f.includes("cat")?l[u]="category":l[u]="ignore"}),T(l)}})}},H=(t,r)=>{T(i=>({...i,[t]:r}))},F=N.useMemo(()=>{const t=Object.values(S);return["date","description","amount","type","category"].every(r=>t.includes(r))},[S]),R=()=>{const t=[{date:"2025-07-30",description:"Groceries",category:"Food",type:"expense",amount:2500},{date:"2025-07-29",description:"Monthly Salary",category:"Salary",type:"income",amount:5e4}],r=M.unparse(t),i=new Blob([r],{type:"text/csv;charset=utf-8;"}),d=document.createElement("a"),l=URL.createObjectURL(i);d.setAttribute("href",l),d.setAttribute("download","cointrail_sample.csv"),document.body.appendChild(d),d.click(),document.body.removeChild(d)},K=async()=>{var r,i,d,l,u,f;if(!p||!s)return;E(!0);const t=b.loading("Starting import...");try{const{data:D,error:z}=await I.from("categories").select("id, name, type").eq("user_id",s.id);if(z)throw new Error(`Failed to fetch categories: ${z.message}`);const J=new Set(D.map(a=>`${a.name.toLowerCase()}|${a.type}`));let P=new Map(D.map(a=>[`${a.name.toLowerCase()}|${a.type}`,a.id]));const k=await new Promise(a=>{M.parse(p,{header:!0,skipEmptyLines:!0,complete:m=>a(m.data)})});b.loading(`Processing ${k.length} rows...`,{id:t});const x=Object.entries(S).reduce((a,[m,o])=>(o!=="ignore"&&(a[o]=m),a),{}),w=new Map;for(const a of k){const m=(r=a[x.category])==null?void 0:r.trim(),o=(i=a[x.type])==null?void 0:i.toLowerCase().trim();if(m&&o&&(o==="income"||o==="expense")){const n=`${m.toLowerCase()}|${o}`;!J.has(n)&&!w.has(n)&&w.set(n,{name:m,type:o})}}if(w.size>0){b.loading(`Creating ${w.size} new categories...`,{id:t});const a=Array.from(w.values()).map(n=>({...n,user_id:s.id})),{data:m,error:o}=await I.from("categories").insert(a).select();if(o)throw new Error(`Failed to create categories: ${o.message}`);m.forEach(n=>P.set(`${n.name.toLowerCase()}|${n.type}`,n.id))}b.loading(`Preparing ${k.length} transactions for import...`,{id:t});const j=[];let A=0;for(const a of k){const m=(d=a[x.category])==null?void 0:d.trim(),o=(l=a[x.type])==null?void 0:l.toLowerCase().trim(),n=parseFloat(a[x.amount]),_=(u=a[x.description])==null?void 0:u.trim(),Q=(f=a[x.date])==null?void 0:f.trim(),q=ne(Q),B=P.get(`${m.toLowerCase()}|${o}`);_&&!isNaN(n)&&n>0&&q&&B?j.push({user_id:s.id,description:_,amount:n,type:o,category_id:B,transaction_date:q.toISOString(),notes:a.notes||null}):A++}if(j.length>0){b.loading(`Importing ${j.length} transactions...`,{id:t});const{error:a}=await I.from("transactions").insert(j);if(a)throw new Error(`Failed to insert transactions: ${a.message}`)}await C(),await v(),b.success(`Import complete! ${j.length} transactions added, ${A} skipped.`,{id:t,duration:5e3}),g("/dashboard")}catch(D){b.error(D.message,{id:t,duration:5e3})}finally{E(!1)}},G=[{value:"date",label:"Date"},{value:"description",label:"Description"},{value:"amount",label:"Amount"},{value:"type",label:"Type (income/expense)"},{value:"category",label:"Category Name"},{value:"ignore",label:"Ignore this column"}];return e.jsxs("div",{className:"min-h-screen bg-dark-primary text-white p-4 sm:p-6",children:[e.jsxs("header",{className:"flex items-center justify-between mb-8",children:[e.jsx("button",{onClick:()=>g(-1),className:"p-2 rounded-full bg-dark-secondary",children:e.jsx(W,{size:24,className:"text-gray-400"})}),e.jsx("h1",{className:"text-xl font-bold",children:"Import Transactions"}),e.jsx("div",{className:"w-10"})]}),e.jsxs(X.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-8",children:[e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"1. Upload CSV File"}),e.jsxs("div",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-700 rounded-xl p-8 text-center mb-4",children:[e.jsx(Y,{size:40,className:"text-gray-500 mb-3"}),e.jsx("h3",{className:"font-semibold",children:"Drag & drop or click to upload"}),e.jsx("input",{type:"file",id:"file-upload",className:"hidden",accept:".csv",onChange:U}),e.jsx("label",{htmlFor:"file-upload",className:"mt-2 text-brand-green font-semibold cursor-pointer hover:underline",children:"Choose a file"})]}),p&&e.jsxs("div",{className:"bg-dark-primary p-3 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{size:20,className:"text-gray-400"}),e.jsx("span",{children:p.name})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[(p.size/1024).toFixed(2)," KB"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(V,{onClick:R,className:"bg-gray-700 hover:bg-gray-600 w-auto text-sm py-2",children:"Download Sample CSV"})})]}),p&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"2. Map Columns"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Match the columns from your CSV to the required fields."}),e.jsx("div",{className:"space-y-3",children:c.map(t=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsx("span",{className:"font-semibold truncate",title:t,children:t}),e.jsx("select",{value:S[t],onChange:r=>H(t,r.target.value),className:"w-full p-2 bg-dark-primary border border-gray-700 rounded-lg text-sm",children:G.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]},t))})]}),p&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"3. Preview & Import"}),!F&&e.jsxs("div",{className:"flex items-center gap-3 bg-yellow-900/50 text-yellow-300 p-3 rounded-lg mb-4 text-sm",children:[e.jsx(ee,{size:20}),e.jsx("p",{children:"Please map all required fields: Date, Description, Amount, Type, Category."})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-700",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-dark-primary",children:e.jsx("tr",{children:c.map(t=>e.jsx("th",{className:"p-3",children:t},t))})}),e.jsx("tbody",{children:y.map((t,r)=>e.jsx("tr",{className:"border-t border-gray-700",children:c.map(i=>e.jsx("td",{className:"p-3 truncate",children:t[i]},i))},r))})]})}),e.jsx("div",{className:"mt-6",children:e.jsx(V,{onClick:K,disabled:!F||L,className:"w-full",children:L?e.jsx(te,{className:"animate-spin"}):"Import Transactions"})})]})]})]})};export{he as default};
