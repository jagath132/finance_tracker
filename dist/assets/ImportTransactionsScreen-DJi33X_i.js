import{j as e,p as E,m as L,K as P,N as V,E as B,a as U,z as N}from"./ui-BvQeeWjB.js";import{e as q,r as x}from"./vendor-C2v42iKu.js";import{B as k}from"./Button-RIE1BFT8.js";import{P as j}from"./papaparse.min-C7c-_Ev6.js";import{u as H}from"./useCategories-Cn9gT5pe.js";import{u as O}from"./useTransactions-ByQLS2az.js";import{u as R}from"./index-z9EIHczJ.js";import"./utils-Bk4gEjOa.js";const K=m=>{if(!m)return null;let r=new Date(m);if(!isNaN(r.getTime()))return r;const y=m.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(y){const[,p,u,i]=y;if(r=new Date(`${i}-${p.padStart(2,"0")}-${u.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const f=m.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(f){const[,p,u,i]=f;if(r=new Date(`${i}-${u.padStart(2,"0")}-${p.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const d=m.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(d){const[,p,u,i]=d;if(r=new Date(`${i}-${u.padStart(2,"0")}-${p.padStart(2,"0")}`),!isNaN(r.getTime()))return r}const g=m.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(g){const[,p,u,i]=g;if(r=new Date(`${i}-${p.padStart(2,"0")}-${u.padStart(2,"0")}`),!isNaN(r.getTime()))return r}return null},ee=()=>{const m=q(),{user:r}=R(),{refetch:y}=H(),{refetch:f}=O(),[d,g]=x.useState(null),[p,u]=x.useState([]),[i,S]=x.useState([]),[b,v]=x.useState({}),[w,C]=x.useState(!1),$=t=>{if(t.target.files&&t.target.files[0]){const a=t.target.files[0];g(a),j.parse(a,{header:!0,skipEmptyLines:!0,preview:5,complete:n=>{u(n.data);const o=n.meta.fields||[];S(o);const l={};o.forEach(s=>{const c=s.toLowerCase();c.includes("date")?l[s]="date":c.includes("desc")?l[s]="description":c.includes("amount")?l[s]="amount":c.includes("type")?l[s]="type":c.includes("cat")?l[s]="category":l[s]="ignore"}),v(l)}})}},M=(t,a)=>{v(n=>({...n,[t]:a}))},D=x.useMemo(()=>{const t=Object.values(b);return["date","description","amount","type","category"].every(a=>t.includes(a))},[b]),T=()=>{const t=[{date:"2025-07-30",description:"Groceries",category:"Food",type:"expense",amount:2500},{date:"2025-07-29",description:"Monthly Salary",category:"Salary",type:"income",amount:5e4}],a=j.unparse(t),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),l=URL.createObjectURL(n);o.setAttribute("href",l),o.setAttribute("download","cointrail_sample.csv"),document.body.appendChild(o),o.click(),document.body.removeChild(o)},I=async()=>{if(!d||!r)return;C(!0);const t=N.loading("Starting import...");try{await new Promise(s=>setTimeout(s,2e3));const a=await new Promise(s=>{j.parse(d,{header:!0,skipEmptyLines:!0,complete:c=>s(c.data)})}),n=Object.entries(b).reduce((s,[c,h])=>(h!=="ignore"&&(s[h]=c),s),{});let o=0,l=0;for(const s of a){const c=s[n.description]?.trim(),h=parseFloat(s[n.amount]),z=s[n.date]?.trim(),A=K(z);c&&!isNaN(h)&&h>0&&A?o++:l++}await f(),await y(),N.success(`Import complete! ${o} transactions added, ${l} skipped.`,{id:t,duration:5e3}),m("/dashboard")}catch(a){N.error(a.message,{id:t,duration:5e3})}finally{C(!1)}},F=[{value:"date",label:"Date"},{value:"description",label:"Description"},{value:"amount",label:"Amount"},{value:"type",label:"Type (income/expense)"},{value:"category",label:"Category Name"},{value:"ignore",label:"Ignore this column"}];return e.jsxs("div",{className:"min-h-screen bg-dark-primary text-white p-4 sm:p-6",children:[e.jsxs("header",{className:"flex items-center justify-between mb-8",children:[e.jsx("button",{onClick:()=>m(-1),className:"p-2 rounded-full bg-dark-secondary",children:e.jsx(E,{size:24,className:"text-gray-400"})}),e.jsx("h1",{className:"text-xl font-bold",children:"Import Transactions"}),e.jsx("div",{className:"w-10"})]}),e.jsxs(L.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-8",children:[e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"1. Upload CSV File"}),e.jsxs("div",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-700 rounded-xl p-8 text-center mb-4",children:[e.jsx(P,{size:40,className:"text-gray-500 mb-3"}),e.jsx("h3",{className:"font-semibold",children:"Drag & drop or click to upload"}),e.jsx("input",{type:"file",id:"file-upload",className:"hidden",accept:".csv",onChange:$}),e.jsx("label",{htmlFor:"file-upload",className:"mt-2 text-brand-green font-semibold cursor-pointer hover:underline",children:"Choose a file"})]}),d&&e.jsxs("div",{className:"bg-dark-primary p-3 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{size:20,className:"text-gray-400"}),e.jsx("span",{children:d.name})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[(d.size/1024).toFixed(2)," KB"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(k,{onClick:T,className:"bg-gray-700 hover:bg-gray-600 w-auto text-sm py-2",children:"Download Sample CSV"})})]}),d&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"2. Map Columns"}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:"Match the columns from your CSV to the required fields."}),e.jsx("div",{className:"space-y-3",children:i.map(t=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 items-center",children:[e.jsx("span",{className:"font-semibold truncate",title:t,children:t}),e.jsx("select",{value:b[t],onChange:a=>M(t,a.target.value),className:"w-full p-2 bg-dark-primary border border-gray-700 rounded-lg text-sm",children:F.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]},t))})]}),d&&e.jsxs("div",{className:"bg-dark-secondary p-6 rounded-2xl",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"3. Preview & Import"}),!D&&e.jsxs("div",{className:"flex items-center gap-3 bg-yellow-900/50 text-yellow-300 p-3 rounded-lg mb-4 text-sm",children:[e.jsx(B,{size:20}),e.jsx("p",{children:"Please map all required fields: Date, Description, Amount, Type, Category."})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-700",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-dark-primary",children:e.jsx("tr",{children:i.map(t=>e.jsx("th",{className:"p-3",children:t},t))})}),e.jsx("tbody",{children:p.map((t,a)=>e.jsx("tr",{className:"border-t border-gray-700",children:i.map(n=>e.jsx("td",{className:"p-3 truncate",children:t[n]},n))},a))})]})}),e.jsx("div",{className:"mt-6",children:e.jsx(k,{onClick:I,disabled:!D||w,className:"w-full",children:w?e.jsx(U,{className:"animate-spin"}):"Import Transactions"})})]})]})]})};export{ee as default};
